apiVersion: v1
kind: Secret
metadata:
  name: credentials
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: ""
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: "xxx=="
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: perf-analyzer-configmap
data:
  config_local.yml: |
    model:
      name: "llama-70b"
      version: "1" # 只有triton server会用到
    serverIp: "127.0.0.1"
    port: 8100
    requestTimeout: 1000 # 超时时间，单位为毫秒，对流式请求无效
    backend: "trt" # 模型用什么框架部署的 vllm / tgi / trt
    #stopWords: []
    maxTokens: 16 # 要求模型一次输出多少个token，影响单条请求的速度
    inputTokens: 1000 # 输入prompt的token数目大概是多长的，目前支持[100, 2000]之间的整百数，越大耗时越长
    stream: true # 测补全这里设置为false，测对话这里设置为true
    
    startConcurrency: 180
    endConcurrency: 5000
    increment: 30
    duration: 1 # 每轮持续几分钟
    timeThresholds: [750, 1000, 1500, 2000, 3000] # 单位为毫秒
    streamSpeedThresholds: 70 # 流式对话场景的每秒token数速度值，低于该值退出测试，取值范围(0, 100]之间的整数
    saveDir: "nullxjx" # 最好使用你的企微id，方便区分
    
    save2Cos: false
    bucket: xxx
    region: ap-shanghai
    subFolder: perf_analyzer
    
    sendMsg: false
    webhookUrl: ""
    user: nullxjx # 你的企微英文id，填了会在群里@你
---
apiVersion: batch/v1
kind: Job
metadata:
  name: perf-analyzer-job
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: perf-analyzer-job
    spec:
      imagePullSecrets:
        - name: credentials
      initContainers:
        - name: perf-analyzer-container
          image: docker.io/thexjx/llm-perf-analyzer:3ec97c92b67cd36c602bb016595b6ed606e173c1
          imagePullPolicy: Always
          env:
            - name: TZ
              value: "Asia/Shanghai"
            - name: CosSecretId
              value: "xxx"
            - name: CosSecretKey
              value: "xxx"
#            - name: "MAX_NEW_TOKENS" # 如果想设置MAX_NEW_TOKENS特定参数，修改这个环境变量，不要加任何空格(下同)
#              value: "256"
#            - name: "INPUT_TOKENS" # 如果想设置INPUT_TOKENS特定参数，修改这个环境变量，目前支持[100, 2000]之间的整百数，越大耗时越长
#              value: "500,1000,1500,2000"
          command: [ "/workspace/perf_tester" ]
          args: [ "custom", "-b", "trt", "-i", "127.0.0.1", "-p", "8000", "-m", "llama-70b", "-u", "nullxjx" ]
          volumeMounts:
            - name: config-volume
              mountPath: /config
            - name: data-volume
              mountPath: /workspace/visualizer
      containers:
        - name: pdf-generator-container
          image: docker.io/thexjx/pdf_generator:3ec97c92b67cd36c602bb016595b6ed606e173c1
          command: [ "python", "process.py", "--json", "/visualizer/peak_results.json", "--type", "inline"]
          env:
            - name: WEBHOOK_URL
              value: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"
          volumeMounts:
            - name: data-volume
              mountPath: /visualizer
      volumes:
        - name: config-volume
          configMap:
            name: perf-analyzer-configmap
        - name: data-volume
          emptyDir: { }
      restartPolicy: OnFailure